var W=Object.defineProperty,Ee=Object.prototype.hasOwnProperty,Te=e=>W(e,"__esModule",{value:!0}),Pe=(e,t)=>{if(Te(e),typeof t=="object"||typeof t=="function")for(let r in t)!Ee.call(e,r)&&r!=="default"&&W(e,r,{get:()=>t[r],enumerable:!0});return e},d=e=>e&&e.__esModule?e:Pe(W({},"default",{value:e,enumerable:!0}),e);function q(e,t,r){}q.throws=!1;global.assert=q;function J(e,t){let r=0;if(t===!0){let s=process.env.TERM||"";r=s&&["xterm","screen","vt100"].some(n=>s.indexOf(n)!=-1)?s.indexOf("256color")!=-1?8:4:2}else t!==!1&&e.isTTY&&(r=e.getColorDepth());return r}function H(e,t){return V(J(e,t),t)}function V(e,t){const r=i=>`[${i}m`,s=e>0||t?(i,o)=>{const a=r(i),l=r(o);return f=>a+f+l}:i=>o=>o,n=e>=8?(i,o,a)=>{let l="["+o+"m",f="["+a+"m";return g=>l+g+f}:e>0?(i,o,a)=>{let l="["+i+"m",f="["+a+"m";return g=>l+g+f}:(i,o,a)=>l=>l;return{_hint:t,ncolors:e,reset:t||e>0?"e[0m":"",bold:s("1","22"),italic:s("3","23"),underline:s("4","24"),inverse:s("7","27"),white:n("37","38;2;255;255;255","39"),grey:n("90","38;5;244","39"),black:n("30","38;5;16","39"),blue:n("34","38;5;75","39"),cyan:n("36","38;5;87","39"),green:n("32","38;5;84","39"),magenta:n("35","38;5;213","39"),purple:n("35","38;5;141","39"),pink:n("35","38;5;211","39"),red:n("31","38;2;255;110;80","39"),yellow:n("33","38;5;227","39"),lightyellow:n("93","38;5;229","39"),orange:n("33","38;5;215","39"),reconfigure(i,o){const a=J(i,o);return a!=this.ncolors&&o!=this._hint&&Object.assign(this,V(a,o)),this}}}const S=H(process.stdout),B=H(process.stderr);const E=d(require("fs")),w=d(require("path")),X=d(require("os")),ke=d(require("perf_hooks")),Q=d(require("util")),x=Symbol("TYPE"),Z=eval("require");function y(e,t){let r={colors:S.ncolors>0};return typeof t=="object"?r={...t}:t!==void 0&&(r.compact=!t),Q.inspect(e,r)}function ee(e){const t=X.homedir();return e=="~"?t:e.startsWith("~"+w.sep)?t+e.substr(1):e}const u=d(require("path")),$=(()=>{const e=process.env._,t=process.argv[1];if(!t)return e||process.argv[0];if(e&&!u.isAbsolute(e))return e;let r="";if(e){const s=u.basename(process.execPath);e.endsWith(u.sep+s)&&(r=s+" ")}if(t.startsWith(process.cwd())){let s=u.relative(process.cwd(),t);if(!s.startsWith("node_modules"+u.sep)&&s.indexOf(u.sep+"node_modules"+u.sep)==-1)return u.sep=="/"&&(s="./"+s),s}return r+u.basename(t)})();class Ke extends Error{constructor(e){super(e);this.name="UserError"}}function te(e,t){return T().printErrorAndExit(e,t)}function re(e,t){Error.prepareStackTrace=void 0;try{if(T().installSourceMapSupport(),Error.prepareStackTrace!==re)return Error.prepareStackTrace(e,t)}catch(r){}return e.stack||String(e)}Error.prepareStackTrace=re;process.on("uncaughtException",te);process.on("unhandledRejection",(e,t)=>{te(e||"PromiseRejection","unhandledRejection")});const ne=d(require("console"));var h;(function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Debug=3]="Debug"})(h||(h={}));let _=console,j;const k=new class{constructor(){this.ERROR=0;this.WARN=1;this.INFO=2;this.DEBUG=3;this.level=2;this.debug=Ce}error(...t){C(t),_.error(B.red(`${$}:`),...t)}warn(...t){k.level>=1&&(C(t),_.error(B.magenta(`${$}:`),...t))}info(...t){k.level>=2&&(C(t),_.log(...t))}get colorMode(){return j}set colorMode(t){if(j===t)return;j=t,t===void 0?_=console:_=new ne.Console({stdout:process.stdout,stderr:process.stderr,colorMode:t})}};var b=k;function C(e){typeof e[0]=="function"&&(e[0]=e[0]())}function Ce(...e){if(k.level>=3){let t="";if(C(e),e.length==0||e.length==1&&(e[0]===""||e[0]===void 0))return;_.log(S.bold(S.blue(`[DEBUG${t}]`)),...e)}}const se=d(require("path"));let N=null,oe=__dirname;function ie(e){oe=e}function T(){return N||(b.debug("loading debug module"),N=Z(se.join(oe,"debug.js"))),N}const Ie=d(require("fs"));function ae(e){return e&&e.read}function le(e){return e&&e.write}const A=Buffer.allocUnsafe(0);function de(e){return e&&typeof e=="object"&&e[x]=="Reader"}function I(e){return e?new Oe(e):Re}function M(e){return e?{[x]:"Writer",stream:e}:Fe}var st;const Re=new class{constructor(){this[st]="Reader"}_E(){return new Error("stream not readable")}get stream(){throw this._E()}[(st=x,Symbol.asyncIterator)](){throw this._E()}read(){return Promise.reject(this._E())}};var ot,ue;const Fe=new(ue=class{constructor(){this[ot]="Writer"}_E(){return new Error("stream not writable")}get stream(){throw this._E()}},ot=x,ue);var it;class Oe{constructor(e){this[it]="Reader";this._ended=!1;this.stream=e,e.pause(),e.once("end",()=>{this._ended=!0})}[(it=x,Symbol.asyncIterator)](){return this.stream[Symbol.asyncIterator]()}async read(e,t){const r=this.stream;if(r.pause(),typeof e=="string")t=e,e=Number.MAX_SAFE_INTEGER;else if(e==null||e<0)e=Number.MAX_SAFE_INTEGER;else if(e==0)return t?"":A;if(r.readable){let o=r.read(this._ended?void 0:e);if(o)return t?o.toString(t):o}if(this._ended)return t?"":A;const s=[];let n=0;if(r.readable){const o=r.read();o&&(s.push(o),n+=o.length)}for(;n<e&&!this._ended;){await new Promise((a,l)=>{r.once("error",l),r.once("end",a),r.once("readable",a)});let o=r.read(e-n);o||(o=r.read()),o&&(s.push(o),n+=o.length)}const i=ce(s);return t?i.toString(t):i}}function ce(e,t){return e.length==0?A:e.length==1?e[0]:Buffer.concat(e,t)}function D(){const e=[];let t=0;const r=e.push;return e.push=s=>(t+=s.length,r.call(e,s)),e.buffer=()=>ce(e,t),e}async function*pe(e,t){let r=[],s=0;for await(const n of e){let i=0;for(;;){let o=n.indexOf(10,i);if(o==-1){if(i<n.length-1){const l=n.subarray(i);r.push(l),s+=l.length}break}o++;let a=n.subarray(i,o);s>0&&(a=Buffer.concat(r.concat(a),s+a.length),r.length=0,s=0),yield t?a.toString(t):a,i=o}}if(r.length>0){const n=Buffer.concat(r,s);yield t?n.toString(t):n}}function G(e){const t=T().libuv_errors;return t[e]||""}function fe(e,t,r){const s=setTimeout(()=>{const n=new Error("timeout");n.name="Timeout",r(n)},t);return e.then(n=>(clearTimeout(s),n),n=>{throw clearTimeout(s),n})}const p=d(require("fs")),me=d(require("os")),he=d(require("child_process")),ge=d(require("stream"));function ye(e,t,r){(!t||!Array.isArray(t))&&(t&&typeof t=="object"&&(r=t),t=[]),r||(r={});const s=new be(e,...t);for(let i in r)s[i]=r[i];const n=s.start();return r&&("stdin"in r||"stdout"in r||"stderr"in r||"extraFiles"in r)?[s,n]:s}const we="process not started";class be{constructor(e,...t){this.dir="";this.env={...process.env};this.shell=!1;this.stdin=null;this.stdout=null;this.stderr=null;this.extraFiles=[];this.windowsHide=!0;this.process=null;this.running=!1;this.pid=0;this.exitCode=-1;this._resolve=()=>{};this._reject=()=>{};this._onerror=e=>{b.debug(()=>`${this} error:
${e.stack||e}`),this._reject(e)};this._onexit=(e,t)=>{const r=this;b.debug(()=>`${r} exited status=${e} signal=${t}`),r.running=!1,e===null||t!==null?(assert(typeof t=="string"),r.exitCode=-(me.constants.signals[t]||1)):r.exitCode=e||0,r._resolve(r.exitCode)};this.command=e,this.args=t,this.promise=Promise.reject(new Error(we)),this.promise.catch(r=>{})}start(){return null}run(e){return this.start(),this.wait(e)}output(e,t){this.stdout="pipe",this.stderr||(this.stderr="pipe");const{stdout:r,stderr:s}=this.start(),n=D(),i=D();return r.stream.on("data",o=>{n.push(o)}),s&&s.stream.on("data",o=>{i.push(o)}),this.wait(t||0).then(o=>{if(o!=0){let l="";const f=i.buffer();try{l=f.toString("utf8")}catch(g){l=f.toString("ascii")}throw l.length>0&&(l=`. stderr output:
`+l),new Error(`command exited with status ${o}${l}`)}const a=n.buffer();return e?a.toString(e):a})}wait(e,t){return e===void 0||e<=0?this.promise:this._waitTimeout(e,(r,s,n)=>(b.debug(()=>`${this} wait timeout reached; killing process`),r.message="Cmd.wait timeout",this.kill(t).then(()=>n(r))))}signal(e,t){const r=this._checkproc();if(t=="group")try{return process.kill(-r.pid,e),!0}catch(s){}return r.kill(e)}async kill(e="SIGTERM",t=500,r){const s=this._checkproc();return this.signal(e,r||"group")?t<=0?this.promise:this._waitTimeout(t,(n,i)=>(b.debug(()=>`${this} kill timeout reached; sending SIGKILL`),s.kill("SIGKILL"),this.promise.then(i))):s.exitCode||0}toString(){return this.process?`Cmd[${this.pid}]`:"Cmd"}_checkproc(){if(!this.process)throw new Error(we);return this.process}_rejectAndKill(e){this._reject(e)}_waitTimeout(e,t){return new Promise((r,s)=>{let n=!1;return this.promise.then(i=>{n||r(i)}),fe(this.promise,e,i=>{n=!0,t(i,r,s)})})}}be.prototype.start=function(){const t=this;if(t.running)throw new Error("start() called while command is running");t.exitCode=-1,t.promise=new Promise((o,a)=>{t._resolve=o,t._reject=a});let r=null,s=null;t.stdin instanceof Buffer?r="pipe":de(t.stdin)?typeof t.stdin.stream.fd=="string"?r=t.stdin.stream:(r="pipe",s=t.stdin.stream):r=t.stdin;const n=he.spawn(t.command,t.args,{stdio:[r,t.stdout===process.stdout?1:t.stdout||"ignore",t.stderr===process.stderr?2:t.stderr?t.stderr:"ignore",...t.extraFiles],cwd:t.dir?ee(t.dir):void 0,env:t.env,shell:t.shell,windowsHide:t.windowsHide,detached:!0});if(n.pid===void 0){t.process=null,t.pid=0;const o=We(t);throw t._reject(o),o}if(t.running=!0,t.process=n,t.pid=n.pid,n.on("exit",t._onexit),n.on("error",t._reject),b.debug(()=>`${t} started (${y(t.command)})`),n.stdin)if(t.stdin instanceof Buffer){const o=new ge.PassThrough;o.end(t.stdin),o.pipe(n.stdin),n.stdin=null}else s&&(s.pipe(n.stdin),n.stdin=null);if(!n.stdin&&!n.stdout&&!n.stderr&&n.stdio.length<4)return null;const i={stdin:n.stdin?M(n.stdin):null,stdout:n.stdout?I(n.stdout):null,stderr:n.stderr?I(n.stderr):null,extraFiles:n.stdio.slice(3).map(o=>ae(o)?I(o):le(o)?M(o):null)};return i};function We(e){let t="",r="unspecified error";if(e.shell==!1){try{p.accessSync(e.dir,p.constants.R_OK|p.constants.X_OK);const n=p.statSync(e.command);(n.mode&p.constants.S_IFREG)==0?t="EACCES":t="EIO"}catch(n){t=n.code||"ENOENT"}r=G(t)||r}if(!t){try{p.accessSync(e.dir,p.constants.R_OK|p.constants.X_OK),t="EIO"}catch(n){t=n.code||"ENOENT"}r=G(t)||r,t&&(r=r+"; cmd.dir="+y(e.dir))}t||(t="UNKNOWN");const s=new Error(`failed to spawn process ${y(e.command)} (${t} ${r})`);return s.code=t,s}const U=d(require("assert")),P=d(require("os")),Y=d(require("path")),Be=require("child_process");ie(__dirname+"/../../dist");process.chdir(__dirname);const $e=!!parseInt(process.env.ESTRELLA_TEST_VERBOSE),v=$e?console.log.bind(console):()=>{};function xe(...e){console.error("FAIL",...e),process.exit(1)}async function ve(e,t){const r={...process.env,IGNORE_SIGTERM:"true",SPAWN_SUBPROCESSES:String(t)};e=="standard"&&(r.FORWARD_SIGTERM="true");const[s,{stdout:n}]=ye(process.execPath,["program1.js"],{stdout:"pipe",stderr:"inherit",env:r});v(`startCmd ${y(s.command)} ${y(s.args)}`);let i=!1,o=0,a=[],l=null,f=0,g=0,L=null;const O="SIGINT",F=c=>{if(s.signal(c,e),e=="standard")for(let m of a)process.kill(m,c)};for await(const c of pe(n,"utf8"))if(v("stdout>>",c.trimEnd()),!i)/mainproc\[\d+\] start/.test(c)&&(i=!0);else if(o<t){const m=c.match(/subproc\d+\[(\d+)\] waiting/);m&&(a.push(parseInt(m[1])),o++),o==t&&(v(`all subprocs launched. PIDs: ${a.join(",")} OK`),v("sending SIGTERM"),l=s.kill("SIGTERM",0,e),L=setTimeout(()=>{F("SIGKILL"),xe("did not finish within 1s")},1e3))}else if(!f||g<t){if(/mainproc\[\d+\] received and ignoring SIGTERM/.test(c)&&(i=!0),/subproc\d+\[\d+\] received and ignoring SIGTERM/.test(c)&&g++,i&&g==t){if(v("all subprocs acknowledge receiving SIGTERM. OK"),R)for(let m of a){const K=await _e(m);K.indexOf(Y.basename(process.execPath))==-1&&console.warn(`subproc [${m}] not found.
getProcessInfoForPID returned:
${K}`)}F(O);break}}else xe("received unexpected command output:",[c]),F("SIGKILL");const Se=await l;if(clearTimeout(L),R)for(let c of a){const m=await _e(c);m.indexOf(Y.basename(process.execPath))!=-1&&console.warn(`subproc [${c}] still running.
getProcessInfoForPID returned:
${m}`)}const z=P.constants.signals[O];U.strictEqual(s.exitCode,-z,`Should exit from signal ${O} (-${z}) but got ${s.exitCode}`),U.strictEqual(Se,s.exitCode)}async function je(){const e=2;R||v("skipping OS-level process liveness checks (unsupported)"),await ve("standard",e),P.platform().startsWith("win")||await ve("group",e)}const R=(()=>{switch(P.platform()){case"darwin":case"freebsd":case"linux":case"openbsd":return"ps ax | awk '$1 == $PID { print $0 }'";case"aix":case"sunos":case"win32":return"";default:return""}})();function _e(e){return new Promise((t,r)=>{const s={},n=R.replace(/\$PID/,e);Be.exec(n,s,(i,o,a)=>{t(o||"")})})}je().catch(e=>{console.error(e.stack||String(e)),process.exit(2)});
