var W=Object.defineProperty,ke=Object.prototype.hasOwnProperty,Ce=e=>W(e,"__esModule",{value:!0}),Ie=(e,t)=>{if(Ce(e),typeof t=="object"||typeof t=="function")for(let r in t)!ke.call(e,r)&&r!=="default"&&W(e,r,{get:()=>t[r],enumerable:!0});return e},d=e=>e&&e.__esModule?e:Ie(W({},"default",{value:e,enumerable:!0}),e);function V(e,t,r){}V.throws=!1;global.assert=V;function H(e,t){let r=0;if(t===!0){let s=process.env.TERM||"";r=s&&["xterm","screen","vt100"].some(n=>s.indexOf(n)!=-1)?s.indexOf("256color")!=-1?8:4:2}else t!==!1&&e.isTTY&&(r=e.getColorDepth());return r}function Q(e,t){return X(H(e,t),t)}function X(e,t){const r=i=>`[${i}m`,s=e>0||t?(i,o)=>{const a=r(i),l=r(o);return f=>a+f+l}:i=>o=>o,n=e>=8?(i,o,a)=>{let l="["+o+"m",f="["+a+"m";return g=>l+g+f}:e>0?(i,o,a)=>{let l="["+i+"m",f="["+a+"m";return g=>l+g+f}:(i,o,a)=>l=>l;return{_hint:t,ncolors:e,reset:t||e>0?"e[0m":"",bold:s("1","22"),italic:s("3","23"),underline:s("4","24"),inverse:s("7","27"),white:n("37","38;2;255;255;255","39"),grey:n("90","38;5;244","39"),black:n("30","38;5;16","39"),blue:n("34","38;5;75","39"),cyan:n("36","38;5;87","39"),green:n("32","38;5;84","39"),magenta:n("35","38;5;213","39"),purple:n("35","38;5;141","39"),pink:n("35","38;5;211","39"),red:n("31","38;2;255;110;80","39"),yellow:n("33","38;5;227","39"),lightyellow:n("93","38;5;229","39"),orange:n("33","38;5;215","39"),reconfigure(i,o){const a=H(i,o);return a!=this.ncolors&&o!=this._hint&&Object.assign(this,X(a,o)),this}}}const E=Q(process.stdout),B=Q(process.stderr);const T=d(require("fs")),w=d(require("path")),Z=d(require("os")),Re=d(require("perf_hooks")),ee=d(require("util")),$=(e,t,r)=>JSON.stringify(e,r,t),x=Symbol("TYPE"),te=eval("require");function y(e,t){let r={colors:E.ncolors>0};return typeof t=="object"?r={...t}:t!==void 0&&(r.compact=!t),ee.inspect(e,r)}function re(e){const t=Z.homedir();return e=="~"?t:e.startsWith("~"+w.sep)?t+e.substr(1):e}const j=new Map,Oe=Symbol("isMemoized");function ne(e){return function(...r){let s=r.map($).join("\0");if(!j.has(s)){const i=e(...r);return j.set(s,i),i}let n=j.get(s);return n&&typeof n=="object"&&(n[Oe]=!0),n}}const u=d(require("path")),N=(()=>{const e=process.env._,t=process.argv[1];if(!t)return e||process.argv[0];if(e&&!u.isAbsolute(e))return e;let r="";if(e){const s=u.basename(process.execPath);e.endsWith(u.sep+s)&&(r=s+" ")}if(t.startsWith(process.cwd())){let s=u.relative(process.cwd(),t);if(!s.startsWith("node_modules"+u.sep)&&s.indexOf(u.sep+"node_modules"+u.sep)==-1)return u.sep=="/"&&(s="./"+s),s}return r+u.basename(t)})();function se(e,t){return P().printErrorAndExit(e,t)}function oe(e,t){Error.prepareStackTrace=void 0;try{if(P().installSourceMapSupport(),Error.prepareStackTrace!==oe)return Error.prepareStackTrace(e,t)}catch(r){}return e.stack||String(e)}Error.prepareStackTrace=oe;process.on("uncaughtException",se);process.on("unhandledRejection",(e,t)=>{se(e||"PromiseRejection","unhandledRejection")});const ie=d(require("console"));var h;(function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Debug=3]="Debug"})(h||(h={}));let _=console,A;const v=new class{constructor(){this.ERROR=0;this.WARN=1;this.INFO=2;this.DEBUG=3;this.level=2;this.infoOnce=ne(()=>v.info.bind(v));this.debug=Fe}error(...t){C(t),_.error(B.red(`${N}:`),...t)}warn(...t){v.level>=1&&(C(t),_.error(B.magenta(`${N}:`),...t))}info(...t){v.level>=2&&(C(t),_.log(...t))}get colorMode(){return A}set colorMode(t){if(A===t)return;A=t,t===void 0?_=console:_=new ie.Console({stdout:process.stdout,stderr:process.stderr,colorMode:t})}};var b=v;function C(e){typeof e[0]=="function"&&(e[0]=e[0]())}function Fe(...e){if(v.level>=3){let t="";if(C(e),e.length==0||e.length==1&&(e[0]===""||e[0]===void 0))return;_.log(E.bold(E.blue(`[DEBUG${t}]`)),...e)}}const ae=d(require("path"));let M=null,le=__dirname;function de(e){le=e}function P(){return M||(b.debug("loading debug module"),M=te(ae.join(le,"debug.js"))),M}const We=d(require("fs"));function ue(e){return e&&e.read}function ce(e){return e&&e.write}const D=Buffer.allocUnsafe(0);function pe(e){return e&&typeof e=="object"&&e[x]=="Reader"}function I(e){return e?new $e(e):Be}function G(e){return e?{[x]:"Writer",stream:e}:je}var dt;const Be=new class{constructor(){this[dt]="Reader"}_E(){return new Error("stream not readable")}get stream(){throw this._E()}[(dt=x,Symbol.asyncIterator)](){throw this._E()}read(){return Promise.reject(this._E())}};var ut,fe;const je=new(fe=class{constructor(){this[ut]="Writer"}_E(){return new Error("stream not writable")}get stream(){throw this._E()}},ut=x,fe);var ct;class $e{constructor(e){this[ct]="Reader";this._ended=!1;this.stream=e,e.pause(),e.once("end",()=>{this._ended=!0})}[(ct=x,Symbol.asyncIterator)](){return this.stream[Symbol.asyncIterator]()}async read(e,t){const r=this.stream;if(r.pause(),typeof e=="string")t=e,e=Number.MAX_SAFE_INTEGER;else if(e==null||e<0)e=Number.MAX_SAFE_INTEGER;else if(e==0)return t?"":D;if(r.readable){let o=r.read(this._ended?void 0:e);if(o)return t?o.toString(t):o}if(this._ended)return t?"":D;const s=[];let n=0;if(r.readable){const o=r.read();o&&(s.push(o),n+=o.length)}for(;n<e&&!this._ended;){await new Promise((a,l)=>{r.once("error",l),r.once("end",a),r.once("readable",a)});let o=r.read(e-n);o||(o=r.read()),o&&(s.push(o),n+=o.length)}const i=me(s);return t?i.toString(t):i}}function me(e,t){return e.length==0?D:e.length==1?e[0]:Buffer.concat(e,t)}function U(){const e=[];let t=0;const r=e.push;return e.push=s=>(t+=s.length,r.call(e,s)),e.buffer=()=>me(e,t),e}async function*he(e,t){let r=[],s=0;for await(const n of e){let i=0;for(;;){let o=n.indexOf(10,i);if(o==-1){if(i<n.length-1){const l=n.subarray(i);r.push(l),s+=l.length}break}o++;let a=n.subarray(i,o);s>0&&(a=Buffer.concat(r.concat(a),s+a.length),r.length=0,s=0),yield t?a.toString(t):a,i=o}}if(r.length>0){const n=Buffer.concat(r,s);yield t?n.toString(t):n}}function z(e){const t=P().libuv_errors;return t[e]||""}function ge(e,t,r){const s=setTimeout(()=>{const n=new Error("timeout");n.name="Timeout",r(n)},t);return e.then(n=>(clearTimeout(s),n),n=>{throw clearTimeout(s),n})}const p=d(require("fs")),be=d(require("os")),ye=d(require("child_process")),we=d(require("stream"));function _e(e,t,r){(!t||!Array.isArray(t))&&(t&&typeof t=="object"&&(r=t),t=[]),r||(r={});const s=new xe(e,...t);for(let i in r)s[i]=r[i];const n=s.start();return r&&("stdin"in r||"stdout"in r||"stderr"in r||"extraFiles"in r)?[s,n]:s}const ve="process not started";class xe{constructor(e,...t){this.dir="";this.env={...process.env};this.shell=!1;this.stdin=null;this.stdout=null;this.stderr=null;this.extraFiles=[];this.windowsHide=!0;this.process=null;this.running=!1;this.pid=0;this.exitCode=-1;this._resolve=()=>{};this._reject=()=>{};this._onerror=e=>{b.debug(()=>`${this} error:
${e.stack||e}`),this._reject(e)};this._onexit=(e,t)=>{const r=this;b.debug(()=>`${r} exited status=${e} signal=${t}`),r.running=!1,e===null||t!==null?(assert(typeof t=="string"),r.exitCode=-(be.constants.signals[t]||1)):r.exitCode=e||0,r._resolve(r.exitCode)};this.command=e,this.args=t,this.promise=Promise.reject(new Error(ve)),this.promise.catch(r=>{})}start(){return null}run(e){return this.start(),this.wait(e)}output(e,t){this.stdout="pipe",this.stderr||(this.stderr="pipe");const{stdout:r,stderr:s}=this.start(),n=U(),i=U();return r.stream.on("data",o=>{n.push(o)}),s&&s.stream.on("data",o=>{i.push(o)}),this.wait(t||0).then(o=>{if(o!=0){let l="";const f=i.buffer();try{l=f.toString("utf8")}catch(g){l=f.toString("ascii")}throw l.length>0&&(l=`. stderr output:
`+l),new Error(`command exited with status ${o}${l}`)}const a=n.buffer();return e?a.toString(e):a})}wait(e,t){return e===void 0||e<=0?this.promise:this._waitTimeout(e,(r,s,n)=>(b.debug(()=>`${this} wait timeout reached; killing process`),r.message="Cmd.wait timeout",this.kill(t).then(()=>n(r))))}signal(e,t){const r=this._checkproc();if(t=="group")try{return process.kill(-r.pid,e),!0}catch(s){}return r.kill(e)}async kill(e="SIGTERM",t=500,r){const s=this._checkproc();return this.signal(e,r||"group")?t<=0?this.promise:this._waitTimeout(t,(n,i)=>(b.debug(()=>`${this} kill timeout reached; sending SIGKILL`),s.kill("SIGKILL"),this.promise.then(i))):s.exitCode||0}toString(){return this.process?`Cmd[${this.pid}]`:"Cmd"}_checkproc(){if(!this.process)throw new Error(ve);return this.process}_rejectAndKill(e){this._reject(e)}_waitTimeout(e,t){return new Promise((r,s)=>{let n=!1;return this.promise.then(i=>{n||r(i)}),ge(this.promise,e,i=>{n=!0,t(i,r,s)})})}}xe.prototype.start=function(){const t=this;if(t.running)throw new Error("start() called while command is running");t.exitCode=-1,t.promise=new Promise((o,a)=>{t._resolve=o,t._reject=a});let r=null,s=null;t.stdin instanceof Buffer?r="pipe":pe(t.stdin)?typeof t.stdin.stream.fd=="string"?r=t.stdin.stream:(r="pipe",s=t.stdin.stream):r=t.stdin;const n=ye.spawn(t.command,t.args,{stdio:[r,t.stdout===process.stdout?1:t.stdout||"ignore",t.stderr===process.stderr?2:t.stderr?t.stderr:"ignore",...t.extraFiles],cwd:t.dir?re(t.dir):void 0,env:t.env,shell:t.shell,windowsHide:t.windowsHide,detached:!0});if(n.pid===void 0){t.process=null,t.pid=0;const o=Ne(t);throw t._reject(o),o}if(t.running=!0,t.process=n,t.pid=n.pid,n.on("exit",t._onexit),n.on("error",t._reject),b.debug(()=>`${t} started (${y(t.command)})`),n.stdin)if(t.stdin instanceof Buffer){const o=new we.PassThrough;o.end(t.stdin),o.pipe(n.stdin),n.stdin=null}else s&&(s.pipe(n.stdin),n.stdin=null);if(!n.stdin&&!n.stdout&&!n.stderr&&n.stdio.length<4)return null;const i={stdin:n.stdin?G(n.stdin):null,stdout:n.stdout?I(n.stdout):null,stderr:n.stderr?I(n.stderr):null,extraFiles:n.stdio.slice(3).map(o=>ue(o)?I(o):ce(o)?G(o):null)};return i};function Ne(e){let t="",r="unspecified error";if(e.shell==!1){try{p.accessSync(e.dir,p.constants.R_OK|p.constants.X_OK);const n=p.statSync(e.command);(n.mode&p.constants.S_IFREG)==0?t="EACCES":t="EIO"}catch(n){t=n.code||"ENOENT"}r=z(t)||r}if(!t){try{p.accessSync(e.dir,p.constants.R_OK|p.constants.X_OK),t="EIO"}catch(n){t=n.code||"ENOENT"}r=z(t)||r,t&&(r=r+"; cmd.dir="+y(e.dir))}t||(t="UNKNOWN");const s=new Error(`failed to spawn process ${y(e.command)} (${t} ${r})`);return s.code=t,s}const Y=d(require("assert")),k=d(require("os")),L=d(require("path")),Ae=require("child_process");de(__dirname+"/../../dist");process.chdir(__dirname);const Me=!!parseInt(process.env.ESTRELLA_TEST_VERBOSE),S=Me?console.log.bind(console):()=>{};function Se(...e){console.error("FAIL",...e),process.exit(1)}async function Te(e,t){const r={...process.env,IGNORE_SIGTERM:"true",SPAWN_SUBPROCESSES:String(t)};e=="standard"&&(r.FORWARD_SIGTERM="true");const[s,{stdout:n}]=_e(process.execPath,["program1.js"],{stdout:"pipe",stderr:"inherit",env:r});S(`startCmd ${y(s.command)} ${y(s.args)}`);let i=!1,o=0,a=[],l=null,f=0,g=0,K=null;const O="SIGINT",F=c=>{if(s.signal(c,e),e=="standard")for(let m of a)process.kill(m,c)};for await(const c of he(n,"utf8"))if(S("stdout>>",c.trimEnd()),!i)/mainproc\[\d+\] start/.test(c)&&(i=!0);else if(o<t){const m=c.match(/subproc\d+\[(\d+)\] waiting/);m&&(a.push(parseInt(m[1])),o++),o==t&&(S(`all subprocs launched. PIDs: ${a.join(",")} OK`),S("sending SIGTERM"),l=s.kill("SIGTERM",0,e),K=setTimeout(()=>{F("SIGKILL"),Se("did not finish within 1s")},1e3))}else if(!f||g<t){if(/mainproc\[\d+\] received and ignoring SIGTERM/.test(c)&&(i=!0),/subproc\d+\[\d+\] received and ignoring SIGTERM/.test(c)&&g++,i&&g==t){if(S("all subprocs acknowledge receiving SIGTERM. OK"),R)for(let m of a){const J=await Ee(m);J.indexOf(L.basename(process.execPath))==-1&&console.warn(`subproc [${m}] not found.
getProcessInfoForPID returned:
${J}`)}F(O);break}}else Se("received unexpected command output:",[c]),F("SIGKILL");const Pe=await l;if(clearTimeout(K),R)for(let c of a){const m=await Ee(c);m.indexOf(L.basename(process.execPath))!=-1&&console.warn(`subproc [${c}] still running.
getProcessInfoForPID returned:
${m}`)}const q=k.constants.signals[O];Y.strictEqual(s.exitCode,-q,`Should exit from signal ${O} (-${q}) but got ${s.exitCode}`),Y.strictEqual(Pe,s.exitCode)}async function De(){const e=2;R||S("skipping OS-level process liveness checks (unsupported)"),await Te("standard",e),k.platform().startsWith("win")||await Te("group",e)}const R=(()=>{switch(k.platform()){case"darwin":case"freebsd":case"linux":case"openbsd":return"ps ax | awk '$1 == $PID { print $0 }'";case"aix":case"sunos":case"win32":return"";default:return""}})();function Ee(e){return new Promise((t,r)=>{const s={},n=R.replace(/\$PID/,e);Ae.exec(n,s,(i,o,a)=>{t(o||"")})})}De().catch(e=>{console.error(e.stack||String(e)),process.exit(2)});
